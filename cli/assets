#!/usr/bin/env php
<?php
if (is_file(__DIR__ . '/../vendor/autoload.php')) {
    require __DIR__ . '/../vendor/autoload.php';
} else if (is_file(__DIR__ . '/../../../autoload.php')) {
    require __DIR__ . '/../../../autoload.php';
}

use Assets\Config;
use Assets\Helper;
use Assets\Uglify\Js;
use Assets\Uglify\Css;

function init($input)
{
    $configFilePath = $input->getArgument('config');
    if ($configFilePath === null) {
        $env = getenv('ASSETS_ENV');
        if (empty($env)) {
            $env = 'development';
        }
        $configFilePath =  __DIR__ . "/../configs/{$env}/assets.php";
    }

    Config::init($configFilePath);
}

$commander = new Commander();
$commander->name('assets')
    ->version('0.1.0')
    ->command(
        array(
            'name' => 'clean',
            'description' => 'Remove old compiled assets',
            'arguments' => array(
                array(
                    'name' => 'config',
                    'description' => 'Path of the config file'
                )
            ),
            'callback' => function($input, $output) {
                init($input);
                $serverRootPath = Config::getServerRootPath();
                $javascriptsRelativePath = ltrim(
                    str_replace($serverRootPath, '', Config::getJavascriptsPath()),
                    DIRECTORY_SEPARATOR
                );
                $stylesheetsRelativePath = ltrim(
                    str_replace($serverRootPath, '', Config::getStylesheetsPath()),
                    DIRECTORY_SEPARATOR
                );

                $serverRootPath = $serverRootPath . DIRECTORY_SEPARATOR;
                Helper::removePath($serverRootPath . 'uglified');
                Helper::removePath($serverRootPath . '.assetsrc');
                Helper::removePath($serverRootPath . 'tmp' . DIRECTORY_SEPARATOR . $javascriptsRelativePath);
                Helper::removePath($serverRootPath . 'tmp' . DIRECTORY_SEPARATOR . $stylesheetsRelativePath);
            }
        )
    )
    ->command(
        array(
            'name' => 'precompile',
            'description' => 'Compile all the assets named in $config["precompile"]["files"]',
            'arguments' => array(
                array(
                    'name' => 'config',
                    'description' => 'Path of the config file'
                )
            ),
            'callback' => function($input, $output) {
                init($input);
                $compiledFiles = array();
                $precompileFiles = Config::getPrecompile();
                $serverRootPath = Config::getServerRootPath();
                foreach ($precompileFiles as $precompileFile) {
                    $precompileFile = ltrim($precompileFile, DIRECTORY_SEPARATOR);
                    $file = new SplFileInfo($precompileFile);
                    $extName = strtolower($file->getExtension());
                    if (empty($extName) || in_array($extName, array('js', 'css')) === false) {
                        continue;
                    }

                    if ($extName === 'js') {
                        $distFile = Js::uglify($precompileFile);
                    } else {
                        $distFile = Css::uglify($precompileFile);
                    }

                    if ($distFile === false) {
                        $output->writeln("<error>Can't compile file : {$precompileFile}</error>");
                    } else {
                        $compiledFiles[$precompileFile] = $distFile;
                        $output->writeln('<info>Create file</info> : ' . $serverRootPath . $distFile);
                    }
                }

                if (!empty($compiledFiles)) {
                    file_put_contents(
                        $serverRootPath . DIRECTORY_SEPARATOR . '.assetsrc',
                        serialize($compiledFiles)
                    );
                }
            }
        )
    )
    ->run();